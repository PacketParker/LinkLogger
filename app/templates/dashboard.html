<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkLogger | Dashboard</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div>
        <!-- Create a table with 4 columns with a total of 1000px width -->
        <table>
            <tr>
                <th>Link</th>
                <th>Visits</th>
                <th>Redirect</th>
                <th>Expire Date</th>
            </tr>
        </table>
    </div>
</body>
</html>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        background-color: #2c3338;
    }

    div {
        display: flex;
        justify-content: center;
        margin-top: 100px;
    }

    table {
        margin: 20px 0 20px 0;
        text-align: center;
        font-size: 25px;
        width: 1250px;
        color: #ccc;
        border-collapse: collapse;
        overflow: hidden;
    }

    table th {
        background-color: #415eac;
        padding: 10px;
        border: 2px solid #ccc;
    }

    .link-table-row {
        border: 2px solid #ccc;
    }

    table td {
        padding: 10px;
    }

    .link-table-row td {
        padding: 20px;
    }

    .log-table-row table td {
        background-color: #3b4148;
        padding: 10px;
    }

    .log-table-row table tr {
        border: 2px solid #ccc;
    }

    .link-button {
        background-color: #3b4148;
        color: #ccc;
        border: none;
        padding: 10px;
        cursor: pointer;
        font-size: 25px;
        border-radius: 5px;
    }

    .fa-trash:hover {
        color: rgb(238, 86, 86);
        cursor: pointer;
    }

</style>

<script>
    async function fetchLinks() {
        const response = await fetch('/api/links');
        if (!response.ok) {
            throw new Error('Failed to fetch links');
        }
        const links = await response.json();
        return links;
    }

    async function fetchLogs(link) {
        const response = await fetch(`/api/links/${link}/logs`);
        if (!response.ok) {
            throw new Error('Failed to fetch logs');
        }
        const logs = await response.json();
        return logs;
    }


    function createRow(index, link, logs) {
        // Create the sub-table with the logs
        let subTable = `
            <table>
                <tr>
                    <th>ID</th>
                    <th>Timestamp</th>
                    <th>IP</th>
                    <th>Location</th>
                    <th colspan="2">ISP</th>
                </tr>
        `;
        // Loop through the logs and create a row for each one
        logs.forEach((log, index) => {
            let row = `
                <tr id="${log.id}-log">
                    <td>${logs.length - index}</td>
                    <td>${log.timestamp}</td>
                    <td>${log.ip}</td>
                    <td>${log.location}</td>
                    <td>${log.isp}</td>
                    <td><i class="fa-solid fa-trash" id="${log.id}/${link.link}""></i></td>
                </tr>
            `;
            subTable += row;
        });
        subTable += '</table>';

        // Convert the link expire timestamp to a readable date
        let date = new Date(link.expire_date);
        let expireDate = date.toLocaleTimeString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });

        // Create the HTML for the row with sub-table
        let row = `
            <tr class="link-table-row">
                <td>
                    <button class="link-button" id="${index}">${link.link}</button>
                </td>
                <td>${logs.length}</td>
                <td>${link.redirect_link}</td>
                <td>${expireDate}</td>
            </tr>
            <tr class="log-table-row" id="${index}-logTR" style="display: none;">
                <td colspan="6">
                    ${subTable}
                </td>
            </tr>
        `;
        return row;
    }



    async function getData() {
        let links = fetchLinks();
        links = await links;

        console.log(links);
        // Links is an Array of objects with the link data
        // Loop through the links and create a row for each one
        links.forEach(async (link, index) => {
            // Fetch the logs for the link
            let logs = await fetchLogs(link.link);
            logs = await logs;
            // Create the entire row with sub-table and logs
            let row = createRow(index, link, logs);
            // Add the new table row to the main table
            document.querySelector('table').innerHTML += row;
        });
    }

    // hideLogRows to all log-table-rows
    function hideLogRows() {
        let logTRs = document.querySelectorAll('.log-table-row');
        logTRs.forEach(row => {
            row.style.display = 'none';
        });
    }

    // Add event listener to all link buttons
    document.addEventListener('click', (event) => {
        if (event.target.classList.contains('link-button')) {
            let id = event.target.id;
            let logTR = document.getElementById(`${id}-logTR`);
            if (logTR.style.display === 'none') {
                hideLogRows();
                logTR.style.display = 'table-row';
            } else {
                logTR.style.display = 'none';
            }
        }
    });

    // Add an event listen to all trash bins
    document.addEventListener('click', (event) => {
        if (event.target.classList.contains('fa-trash')) {
            let id = event.target.id;
            let link = id.split('/')[1];
            let logId = id.split('/')[0];
            fetch(`/api/links/${link}/logs/${logId}`, {
                method: 'DELETE'
            });
            let logRow = document.getElementById(`${logId}-log`)
            logRow.remove();
        }
    });

    getData();
</script>